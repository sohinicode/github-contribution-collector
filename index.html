import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, limit } from 'firebase/firestore';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'sohini-collector-app';

const GITHUB_PROFILE_URL = "https://github.com/sohinicode";

export default function App() {
  const [user, setUser] = useState(null);
  const [leaderboard, setLeaderboard] = useState([]);
  const [gameState, setGameState] = useState('START'); // START, PLAYING, PAUSED, GAMEOVER
  const [score, setScore] = useState(0);
  const [streak, setStreak] = useState(0);
  const [personalBest, setPersonalBest] = useState(0);
  const [username, setUsername] = useState('');
  
  const canvasRef = useRef(null);
  const gameRef = useRef({
    player: { x: 170, y: 460, width: 60, height: 12, speed: 8, dx: 0 },
    items: [],
    frameCount: 0,
    keys: {},
    lastEscTime: 0
  });

  // 1. Auth Init (Rule 3)
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. Leaderboard Sync (Rule 1 & 2)
  useEffect(() => {
    if (!user) return;
    const q = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const docs = snapshot.docs.map(d => d.data());
      // Sort in memory (Rule 2)
      const sorted = docs.sort((a, b) => b.score - a.score).slice(0, 5);
      setLeaderboard(sorted);
      
      // Sync personal best
      const mine = docs.find(d => d.uid === user.uid);
      if (mine) setPersonalBest(mine.score);
    }, (err) => console.error("Firestore error:", err));

    return () => unsubscribe();
  }, [user]);

  // 3. Game Engine
  useEffect(() => {
    if (gameState !== 'PLAYING') return;

    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    let animationId;

    const handleKeyDown = (e) => {
      gameRef.current.keys[e.code] = true;
      if (e.code === 'Escape') {
        const now = Date.now();
        if (now - gameRef.current.lastEscTime < 500) {
          window.location.href = GITHUB_PROFILE_URL;
        } else {
          gameRef.current.lastEscTime = now;
          setGameState('PAUSED');
        }
      }
    };
    const handleKeyUp = (e) => gameRef.current.keys[e.code] = false;

    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('keyup', handleKeyUp);

    const update = () => {
      const g = gameRef.current;
      
      // Movement
      if (g.keys['ArrowLeft'] || g.keys['KeyA']) g.player.dx = -g.player.speed;
      else if (g.keys['ArrowRight'] || g.keys['KeyD']) g.player.dx = g.player.speed;
      else g.player.dx = 0;

      g.player.x += g.player.dx;
      if (g.player.x < 0) g.player.x = 0;
      if (g.player.x > 340) g.player.x = 340;

      // Spawning
      g.frameCount++;
      if (g.frameCount % Math.max(15, 50 - Math.floor(score / 3)) === 0) {
        const isBug = Math.random() < 0.25;
        g.items.push({
          x: Math.random() * 380,
          y: -20,
          size: 20,
          type: isBug ? 'bug' : 'commit',
          speed: 3 + (score / 15)
        });
      }

      ctx.clearRect(0, 0, 400, 500);
      
      // Player
      ctx.fillStyle = '#58a6ff';
      ctx.fillRect(g.player.x, g.player.y, g.player.width, g.player.height);

      // Items
      for (let i = g.items.length - 1; i >= 0; i--) {
        const item = g.items[i];
        item.y += item.speed;

        if (item.type === 'commit') {
          ctx.fillStyle = '#39d353';
          ctx.fillRect(item.x, item.y, item.size, item.size);
        } else {
          ctx.fillStyle = '#f85149';
          ctx.font = 'bold 20px sans-serif';
          ctx.fillText('!', item.x + 5, item.y + 18);
        }

        if (item.y + 20 > g.player.y && item.x < g.player.x + 60 && item.x + 20 > g.player.x) {
          if (item.type === 'commit') {
            setScore(prev => prev + 1);
            setStreak(prev => prev + 1);
            g.items.splice(i, 1);
          } else {
            setGameState('GAMEOVER');
          }
        } else if (item.y > 500) {
          if (item.type === 'commit') setStreak(0);
          g.items.splice(i, 1);
        }
      }

      animationId = requestAnimationFrame(update);
    };

    update();
    return () => {
      window.removeEventListener('keydown', handleKeyDown);
      window.removeEventListener('keyup', handleKeyUp);
      cancelAnimationFrame(animationId);
    };
  }, [gameState, score]);

  const saveScore = async () => {
    if (!user || !username) return;
    const finalScore = score > personalBest ? score : personalBest;
    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', user.uid);
    await setDoc(docRef, {
      uid: user.uid,
      username: username.replace('@', ''), // Clean username
      score: finalScore,
      github: `https://github.com/${username.replace('@', '')}`
    });
    setGameState('START');
    setScore(0);
    setStreak(0);
  };

  const globalTop = leaderboard[0];

  return (
    <div className="min-h-screen bg-[#0d1117] text-[#c9d1d9] font-mono flex flex-col items-center justify-center p-4">
      {/* Header Stats */}
      <div className="w-[400px] max-w-full flex flex-col bg-[#161b22] border border-[#30363d] p-3 rounded-t-lg space-y-1">
        <div className="flex justify-between items-center text-xs text-gray-400">
          <span>Personal Best: {personalBest}</span>
          <span className="flex items-center gap-1 text-[#e3b341]">
            üèÜ All-time Best: 
            {globalTop ? (
              <a 
                href={globalTop.github} 
                target="_blank" 
                className="underline hover:text-white"
              >
                @{globalTop.username}
              </a>
            ) : '...'} 
            ({globalTop?.score || 0})
          </span>
        </div>
        <div className="flex justify-between items-end pt-1">
          <div className="text-lg">Commits: <span className="text-[#39d353] font-bold">{score}</span></div>
          <div className="text-xs text-gray-500">Streak: {streak}</div>
        </div>
      </div>

      <div className="relative">
        <canvas 
          ref={canvasRef} 
          width={400} 
          height={500} 
          className="bg-[#010409] border-2 border-[#30363d] rounded-b-lg shadow-2xl"
        />

        {(gameState === 'START' || gameState === 'PAUSED' || gameState === 'GAMEOVER') && (
          <div className="absolute inset-0 bg-black/90 flex flex-col items-center justify-center text-center p-6 rounded-b-lg">
            {gameState === 'START' && (
              <>
                <h1 className="text-3xl font-bold mb-2">Contribution Collector</h1>
                <p className="text-gray-400 mb-6 text-sm italic">"Consistency beats motivation"</p>
                <button 
                  onClick={() => { setScore(0); setGameState('PLAYING'); }}
                  className="bg-[#238636] hover:bg-[#2ea043] px-8 py-3 rounded-md font-bold text-white transition-all w-full"
                >
                  Start Deployment
                </button>
              </>
            )}

            {gameState === 'PAUSED' && (
              <>
                <h2 className="text-2xl font-bold mb-4">Deployment Paused</h2>
                <button 
                  onClick={() => setGameState('PLAYING')}
                  className="bg-[#238636] hover:bg-[#2ea043] px-8 py-3 rounded-md font-bold text-white transition-all w-full"
                >
                  Resume
                </button>
              </>
            )}

            {gameState === 'GAMEOVER' && (
              <div className="w-full">
                <h2 className="text-2xl font-bold text-red-500 mb-1">Build Failed!</h2>
                <p className="mb-4 text-sm">You collected <span className="text-[#39d353]">{score}</span> commits.</p>
                
                <div className="bg-[#161b22] p-4 rounded-lg border border-[#30363d] mb-4">
                   <label className="block text-xs text-left mb-1 text-gray-400">Save your score to the leaderboard:</label>
                   <input 
                    type="text" 
                    placeholder="Your GitHub Username" 
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    className="bg-[#0d1117] border border-[#30363d] p-2 rounded w-full mb-3 text-sm focus:border-[#58a6ff] outline-none"
                  />
                  <button 
                    onClick={saveScore}
                    disabled={!username}
                    className="bg-[#238636] hover:bg-[#2ea043] disabled:opacity-50 px-8 py-2 rounded font-bold text-white transition-all w-full text-sm"
                  >
                    Commit & Save
                  </button>
                </div>

                <button 
                  onClick={() => setGameState('START')}
                  className="text-gray-500 hover:text-white text-xs"
                >
                  Skip and Restart
                </button>
              </div>
            )}

            <button 
              onClick={() => window.location.href = GITHUB_PROFILE_URL}
              className="mt-6 text-blue-400 hover:underline text-xs"
            >
              Back to Sohini's Profile
            </button>
          </div>
        )}
      </div>

      {/* Leaderboard Section */}
      <div className="w-[400px] max-w-full mt-6 bg-[#161b22] border border-[#30363d] rounded-lg p-4 shadow-lg">
        <h3 className="text-center font-bold mb-3 border-b border-[#30363d] pb-2 text-[#58a6ff] flex items-center justify-center gap-2">
          üèÜ Top Builders
        </h3>
        {leaderboard.length === 0 ? (
          <p className="text-center text-gray-500 text-sm italic py-4">Checking git logs...</p>
        ) : (
          <div className="space-y-3">
            {leaderboard.map((entry, i) => (
              <div key={i} className={`flex justify-between items-center text-sm p-2 rounded ${i === 0 ? 'bg-[#23863622] border border-[#23863644]' : ''}`}>
                <div className="flex items-center gap-3">
                  <span className={`w-4 text-xs font-bold ${i === 0 ? 'text-[#e3b341]' : 'text-gray-500'}`}>{i + 1}</span>
                  <a 
                    href={entry.github} 
                    target="_blank" 
                    rel="noopener noreferrer"
                    className="text-[#58a6ff] hover:underline font-medium flex items-center gap-1"
                  >
                    @{entry.username}
                    {i === 0 && <span className="text-[10px] bg-[#e3b341] text-black px-1 rounded uppercase font-black">MVP</span>}
                  </a>
                </div>
                <div className="font-bold text-[#39d353] tabular-nums">{entry.score}</div>
              </div>
            ))}
          </div>
        )}
      </div>

      <div className="mt-6 text-[10px] text-gray-600 flex gap-4">
        <span>ESC to Pause</span>
        <span>Double ESC to Exit</span>
      </div>
    </div>
  );
}
